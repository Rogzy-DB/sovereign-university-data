---
name: RGB CLI
description: Как создавать и обмениваться смарт-контрактами в RGB?
---
![cover](assets/cover.webp)

В этом руководстве мы рассмотрим пошаговый процесс написания контракта с помощью инструмента командной строки `rgb`, созданного ассоциацией LNP/BP. Цель - показать, как установить и работать с CLI, скомпилировать схему, импортировать интерфейс и реализацию интерфейса, а затем выпустить актив RGB. Мы также рассмотрим базовую логику, включая компиляцию и проверку состояния. В конце этого урока вы сможете воспроизвести процесс и создать свои собственные RGB-контракты.

## Напоминание о протоколе RGB

RGB - это протокол, который работает поверх Bitcoin и эмулирует функциональность смарт-контрактов и управление цифровыми активами, не перегружая блокчейн, на котором он основан. В отличие от обычных внутрицепочечных смарт-контрактов (как, например, в Ethereum), RGB опирается на систему "*Client-side validation*": большинство данных и истории состояний обмениваются и хранятся исключительно самими участниками, тогда как в блокчейне Bitcoin хранятся лишь небольшие криптографические обязательства (через такие механизмы, как *Tapret* или *Opret*). Таким образом, в протоколе RGB блокчейн Биткойна служит только сервером таймстампинга и системой защиты от двойных трат.

Контракт RGB по своей структуре напоминает эволюционную машину состояний. Он начинается с Генезиса, определяющего начальное состояние (описывающего, например, поставку, тикер или другие метаданные) в соответствии со строго типизированной и скомпилированной Схемой. Затем для изменения или расширения этого состояния применяются Переходы состояния и, при необходимости, Расширения состояния. Каждая операция, будь то передача взаимозаменяемых активов (RGB20) или создание уникальных активов (RGB21), включает в себя *Пломбы однократного использования*. Они связывают Bitcoin UTXO с внецепочечными состояниями и предотвращают двойные траты, обеспечивая конфиденциальность и масштабируемость.

Чтобы узнать больше о том, как работает протокол RGB, я рекомендую вам пройти этот полный курс обучения:

https://planb.network/courses/3ce1d37c-05ba-4f54-aa15-7586d37b2bb7

Внутренняя логика RGB основана на библиотеках Rust, которые вы, как разработчики, можете импортировать в свои проекты для управления частью *Client-side Validation*. Кроме того, команда LNP/BP работает над привязками для других языков, но эта работа еще не завершена. Кроме того, другие организации, такие как Bitfinex, разрабатывают свои собственные интеграционные стеки, но о них мы поговорим в другом руководстве. На данный момент CLI `rgb` является официальным эталоном, даже если он остается относительно недоработанным.

## Установка и представление инструмента rgb CLI

Основная команда называется просто `rgb`. Она напоминает `git`, с набором подкоманд для работы с контрактами, их вызовом, выпуском активов и так далее. Bitcoin Wallet в настоящее время не интегрирован, но будет интегрирован в ближайшей версии (0.11). Следующая версия позволит пользователям создавать и управлять своими кошельками (через дескрипторы) непосредственно из `rgb`, включая генерацию PSBT, совместимость с внешним оборудованием (например, аппаратным кошельком) для подписи и взаимодействие с таким программным обеспечением, как Sparrow. Это упростит весь сценарий эмиссии и передачи активов.

### Установка через Cargo

Мы устанавливаем инструмент в Rust с :

```bash
cargo install rgb-contracts --all-features
```

(Примечание: крейт называется `rgb-contracts`, а установленная команда будет называться `rgb`. Если крейт с именем `rgb` уже существовал, могло произойти столкновение, отсюда и название)

При установке компилируется большое количество зависимостей (например, парсинг команд, интеграция Electrum, управление доказательствами нулевого знания и т. д.).

По завершении установки в меню :

```bash
rgb
```

Запуск `rgb` (без аргументов) выводит список доступных подкоманд, таких как `interfaces`, `chema`, `import`, `export`, `issue`, `invoice`, `transfer` и т.д. Вы можете изменить директорию локального хранилища (тайник, в котором хранятся все журналы, схемы и реализации), выбрать сеть (testnet, mainnet) или настроить свой сервер Electrum.

![RGB-CLI](assets/fr/01.webp)

### Первый обзор элементов управления

Выполнив следующую команду, вы увидите, что интерфейс `RGB20` уже интегрирован по умолчанию:

```bash
rgb interfaces
```

Если этот интерфейс не интегрирован, клонируйте файл :

```bash
git clone https://github.com/RGB-WG/rgb-interfaces
```

Скомпилируйте его:

```bash
cargo run
```

Затем импортируйте выбранный вами интерфейс:

```bash
rgb import interfaces/RGB20.rgb
```

![RGB-CLI](assets/fr/02.webp)

Однако нам сообщили, что ни одна схема еще не была импортирована в программное обеспечение. В тайнике также нет контракта. Чтобы увидеть его, выполните команду :

```bash
rgb schemata
```

Затем вы можете клонировать хранилище, чтобы получить определенные схемы:

```bash
git clone https://github.com/RGB-WG/rgb-schemata
```

![RGB-CLI](assets/fr/03.webp)

Этот репозиторий содержит в директории `src/` несколько файлов Rust (например, `nia.rs`), которые определяют схемы (NIA для "*Ненадуваемый актив*", UDA для "*Уникальный цифровой актив*" и т.д.). Для компиляции можно выполнить команду :

```bash
cd rgb-schemata
cargo run
```

В результате создается несколько файлов `.rgb` и `.rgba`, соответствующих скомпилированным схемам. Например, вы найдете `NonInflatableAsset.rgb`.

### Импорт схемы и реализации интерфейса

Теперь вы можете импортировать схему в `rgb` :

```bash
rgb import schemata/NonInflatableAssets.rgb
```

![RGB-CLI](assets/fr/04.webp)

Это добавляет ее в локальный архив. Если мы выполним следующую команду, то увидим, что схема теперь появилась:

```bash
rgb schemata
```

## Создание контракта (выдача)

Существует два подхода к созданию нового актива:


- Либо мы используем скрипт или код на Rust, который создает Контракт, заполняя поля схемы (глобальное состояние, Владельческие состояния и т.д.) и создавая файл `.rgb` или `.rgba`;
- Или используйте подкоманду `issue` напрямую, с файлом YAML (или TOML), описывающим свойства токена.

Вы можете найти примеры в Rust в папке `examples`, которые иллюстрируют, как вы создаете `ContractBuilder`, заполняете `глобальное состояние` (имя актива, тикер, поставка, дата и т.д.), определяете Owned State (к какому UTXO он приписан), затем собираете все это в *contract consignment*, который вы можете экспортировать, подтвердить и импортировать в тайник.

Другой способ - вручную отредактировать YAML-файл, чтобы настроить `ticker`, `name`, `upply` и так далее. Предположим, файл называется `RGB20-demo.yaml`. Вы можете указать :


- `spec`: тикер, название, точность ;
- `термы`: поле для юридических уведомлений ;
- `Выпущенный запас` : количество выпущенных токенов;
- `Назначения`: указывает на одноразовую пломбу (*определение пломбы*) и разблокированное количество.

Вот пример YAML-файла, который нужно создать:

```yaml
interface: RGB20Fixed
globals:
spec:
ticker: PBN
name: Plan B Network
details: "Pay attention: the asset has no value"
precision: 2
terms:
text: >
SUBJECT TO, AND WITHOUT IN ANY WAY LIMITING, THE REPRESENTATIONS AND WARRANTIES OF ANY SELLER. PROPERTY IS BEING SOLD “AS IS”...
media: ~
issuedSupply: 100000000
assignments:
assetOwner:
seal: tapret1st:b449f7eaa3f98c145b27ad0eeb7b5679ceb567faef7a52479bc995792b65f804:1
amount: 100000000 # this is 1 million (we have two digits for cents)
```

![RGB-CLI](assets/fr/05.webp)

Затем просто выполните команду :

```bash
rgb issue '<SchemaID>' ssi:<Issuer> rgb20-demo.yaml
```

![RGB-CLI](assets/fr/06.webp)

В моем случае уникальный идентификатор схемы (должен быть заключен в одинарные кавычки) - `RDYhMTR!9gv8Y2GLv9UNBEK1hcrCmdLDFk9Qd5fnO8k`, и я не указал эмитента. Итак, мой заказ: :

```txt
rgb issue 'RDYhMTR!9gv8Y2GLv9UNBEK1hcrCmdLDFk9Qd5fnO8k' ssi:anonymous rgb20-demo.yaml
```

Если вы не знаете идентификатор схемы, выполните команду :

```bash
rgb schemata
```

CLI отвечает, что новый контракт был выпущен и добавлен в тайник. Если мы введем следующую команду, то увидим, что теперь есть дополнительный контракт, соответствующий только что выпущенному:

```bash
rgb contracts
```

![RGB-CLI](assets/fr/07.webp)

Затем следующая команда выводит глобальные состояния (имя, тикер, предложение...) и список Owned States, то есть распределений (например, 1 миллион токенов `PBN`, определенных в UTXO `b449f7eaa3f98c145b27ad0eeb7b5679ceb567faef7a52479bc995792b65f804:1`).

```bash
rgb state '<ContractId>'
```

![RGB-CLI](assets/fr/08.webp)

## Экспорт, импорт и проверка

Чтобы поделиться этим контрактом с другими пользователями, его можно экспортировать из тайника в файл :

```bash
rgb export '<ContractId>' myContractPBN.rgb
```

![RGB-CLI](assets/fr/09.webp)

Файл `myContractPBN.rgb` может быть передан другому пользователю, который может добавить его в свой тайник с помощью команды :

```bash
rgb import myContractPBN.rgb
```

При импорте, если это простая *контрактная партия*, мы получим сообщение "`Importing consignment rgb`". Если это более крупная *переходная партия*, команда будет другой (`rgb accept`).

Для обеспечения достоверности можно также использовать локальную функцию проверки. Например, можно выполнить команду :

```bash
rgb validate myContract.rgb
```

### Использование, проверка и отображение тайников

Напомним, что тайник - это локальный список схем, интерфейсов, реализаций и контрактов (Genesis + переходы). Каждый раз, когда вы выполняете команду "import", вы добавляете элемент в тайник. Этот тайник можно просмотреть в деталях с помощью команды :

```bash
rgb dump
```

![RGB-CLI](assets/fr/10.webp)

В результате будет создана папка с подробной информацией обо всем тайнике.

## Трансфер и PSBT

Чтобы осуществить перевод, вам потребуется манипулировать локальным кошельком Bitcoin для управления обязательствами `Tapret` или `Opret`.

### Создайте счет-фактуру

В большинстве случаев взаимодействие между участниками контракта (например, Алисой и Бобом) происходит через создание счета-фактуры. Если Алиса хочет, чтобы Боб что-то выполнил (передачу токена, перевыпуск, действие в DAO и т. д.), Алиса создает счет-фактуру, в котором подробно описывает свои инструкции Бобу. Таким образом, мы имеем :


- Алиса** (эмитент счета-фактуры) ;
- Боб** (который получает и исполняет счет-фактуру).

В отличие от других экосистем, RGB-счет не ограничивается понятием оплаты. Он может содержать любой запрос, связанный с контрактом: отозвать ключ, проголосовать, создать гравировку (*engraving*) на NFT и т. д. Соответствующая операция может быть описана в интерфейсе контракта. Соответствующая операция может быть описана в интерфейсе контракта.

Следующая команда генерирует RGB-фактуру:

```bash
$ rgb invoice $CONTRACT -i $INTERFACE $ACTION $STATE $SEAL
```

С :


- `$CONTRACT`: Идентификатор контракта (*ContractId*) ;
- `$INTERFACE`: интерфейс, который будет использоваться (например, `RGB20`) ;
- `$ACTION`: имя операции, указанной в интерфейсе (для простой передачи сменного токена это может быть "Transfer"). Если интерфейс уже предоставляет действие по умолчанию, вам не нужно вводить его здесь снова;
- `$STATE`: данные о состоянии, которые будут переданы (например, количество токенов, если передается сменный токен);
- `$SEAL`: одноразовая печать получателя (Алисы), т.е. явная ссылка на UTXO. Боб будет использовать эту информацию для создания транзакции-свидетеля, и соответствующий выход будет принадлежать Алисе (в *ослепленном UTXO* или незашифрованном виде).

Например, с помощью следующих команд

```bash
alice$ CONTRACT='iZgIN9EL-2H21UgQ-x!A3uJc-WwXhCSm-$9Lwcc1-v!mUkKY'
alice$ MY_UTXO=4960acc21c175c551af84114541eace09c14d3a1bb184809f7b80916f57f9ef8:1
alice$ rgb invoice $CONTRACT -i RGB20 --amount 100 $MY_UTXO
```

CLI создаст счет-фактуру, как :

```bash
rgb:iZgIN9EL-2H21UgQ-x!A3uJc-WwXhCSm-$9Lwcc1-v!mUkKY/RGB20/100+utxob:zlVS28Rb-...
```

Она может быть передана Бобу по любому каналу (текст, QR-код и т. д.).

### Осуществление перевода

Для переноса из этого счета :


- У Боба (который хранит токены в своем тайнике) есть кошелек Bitcoin. Ему необходимо подготовить транзакцию Bitcoin (в форме PSBT, например `tx.psbt`), которая расходует UTXO, где находятся необходимые токены RGB, плюс один UTXO для валюты (обмена);
- Боб выполняет следующую команду:

```bash
bob$ rgb transfer tx.psbt $INVOICE consignment.rgb
```


- В результате создается файл `consignment.rgb`, который содержит :
 - История перехода доказывает Алисе, что токены подлинные;
 - Новый переход, передающий жетоны на одноразовую печать Алисы;
 - Транзакция свидетеля (без знака).
- Боб отправляет этот файл `consignment.rgb` Алисе (по электронной почте, через сервер совместного доступа или протокол RGB-RPC, Storm и т. д.);
- Алиса получает `consignment.rgb` и принимает его в свой тайник:

```bash
alice$ rgb accept consignment.rgb
```


- CLI проверяет валидность перехода и добавляет его в тайник Алисы. Если он недействителен, команда завершается неудачей с подробным сообщением об ошибке. В противном случае она завершается успешно и сообщает, что пример транзакции еще не был передан в сеть Биткойн (Боб ждет зеленого света от Алисы);
- В качестве подтверждения команда `accept` возвращает подпись (*payslip*), которую Алиса может отправить Бобу, чтобы показать ему, что она подтвердила *назначение*;
- Затем Боб может подписать и опубликовать (`--publish`) свою транзакцию Bitcoin:

```bash
bob$ rgb check <sig> && wallet sign --publish tx.psbt
```


- Как только эта транзакция подтверждается на цепочке, право собственности на актив считается переданным Алисе. Кошелек Алисы, следящий за майнингом транзакции, видит, как в его тайнике появляется новое состояние Owned State.

Теперь вы знаете, как оформить и передать RGB-контракт. Если вы нашли это руководство полезным, я буду очень благодарен, если вы поставите "зеленый палец" ниже. Пожалуйста, не стесняйтесь поделиться этой статьей в своих социальных сетях. Большое спасибо!

Я также рекомендую этот другой учебник, в котором я объясняю, как запустить RGB-совместимую ноду Lightning для обмена токенами почти мгновенно:

https://planb.network/tutorials/node/rgb/rln-ffc02528-329b-4e16-bd83-873d0299feea
